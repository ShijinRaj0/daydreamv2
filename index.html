<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pixum Opus</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
      integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Lobster&display=swap");
      body{
        background: #f1eef2;
     
      }
      
      .container{
        background: white;
        border-radius: 20px;
        padding: 0px;
      }
      .img {
        width: 500px;
        height: 500px;
      }
      .selection-box {
        position: absolute;
        /* border: 1px solid red; */
        transition: all 0.5s ease;
        /* box-shadow: 1px 1px 1px 1px; */
      }
      .output-grid {
        display: grid;
        grid-gap: 0px;
        /* grid-template-columns: repeat(4, 100px);
    grid-template-rows: repeat(4,100px); */
      }
      .grid-item {
        width: 100px;
        height: 100px;
      }
      .sub-image {
        width: 200px;
        height: 200px;
      }

      .logo {
        font-family: "Lobster", cursive;

        font-size: 2.5rem;
        cursor: pointer;
        padding:2rem;
        color: white;
        background: rgb(47, 3, 68);
        transition: all 1s ease;
      }
      .logo .sub-text {
        color: orange;
      }

      .logo:hover{
        padding:2rem 4rem 2rem 4rem;
      }

      .image-box{
        width: 200px;
        height: 200px;
display: flex;
justify-content: center;
align-items: center;
background: #f1eef2;
color: #a4a4a4;
font-size: 14px;
transition: all 1s ease;
border-radius: 10px;
border:1px dashed;
background-size: cover;
      }

      .alt-img{
        cursor: pointer;
        transition: all 0.3s ease;
      }
     .alt-img:hover{
       margin-top: -30px;
     }

     .footer{
      background: rgb(47, 3, 68);
      padding: 1rem;
      color: rgb(179, 178, 178);
      text-align: center;
      font-family: "Lobster", cursive;
     }
    </style>

    <div class="container">
      <div class="logo">PIXUM <span class="sub-text">OPUS</span></div>
      <div>
        <div class="d-flex border flex-nowrap p-4" id="previewSource"> 
          <div class="image-box m-3" >
            <div class="d-flex justify-content-center flex-column align-items-center">
              <img class="alt-img" src="assets/gallery.png" width="100px" alt=""  onclick="triggerFileInput('sourceInput')"/>
              <div>Choose a canvas image</div>
            </div>
          </div>
        </div>
        <div class="d-flex border flex-wrap p-4" id="previewSubSource">
          <div class="image-box m-3" onclick="triggerFileInput('sourceSubInput')">
            <div class="d-flex justify-content-center flex-column align-items-center">
              <img class="alt-img" src="assets/gallery.png" width="100px" alt=""/>
              <div class="text-center">Choose multiple <br/>images to combine</div>
            </div>
          </div>
  
      
        </div>
        <div class="border p-4 d-flex align-items-end justify-content-end">
          <button class="btn btn-primary btn-lg mx-3" id="btnRender">
            Render
          </button>

        </div>
      </div>

      <input type="file" onchange="readURL(this);" id="sourceInput"  class="d-none"/>
      <input
        type="file"
        id="sourceSubInput"
        name="subimage[]"
        multiple
        onchange="readMultipleFiles(this)"
        class="d-none"
      />

      <div class="sub-img-container d-flex flex-wrap mt-4 d-none" id="source"></div>

      <div class="d-flex align-items-center d-none">
        <label for="blockSize" class="px-2">Block Size</label>
        <input
          type="range"
          id="blockSize"
          class="ml-2"
          min="5"
          value="5"
          max="100"
          step="5"
          placeholder="Block Size"
        />
        <div
          class="
            d-flex
            justify-content-center
            align-items-center
            mx-2
            border
            rounded-circle
          "
          style="width: 32px; height: 32px"
        >
          <span id="sliderVal" class="text-center text-primary p-2">5</span>
        </div>
        
      </div>
     
      <div id="imgContainer" class="img-container mt-3 d-flex" >
        <div id="sourceContainer">
          <!-- https://picsum.photos/500 for random pictures -->
          <img src="" alt="" id="i" crossorigin="anonymous" />
          <a href="" id="downloadLink" download="Daydream.png">
            <img
              src=""
              alt="preview"
              id="preview"
              crossorigin="anonymous"
              width="500px"
              height="500px"
              style="cursor: pointer;"
            />
          </a>
        </div>
        <div id="outputContainer">
          <div
            class="spinner-border text-primary m-2"
            style="display: none"
            role="status"
            id="outputLoader"
          >
            <span class="sr-only"></span>
          </div>
        </div>
      </div>
      <canvas
        id="outputCanvas"
        width="5000"
        height="5000"
        style="border: 1px solid black; display: none"
      >
      </canvas>
      <div class="footer">
Shijin Raj
      </div>
    </div>

    <script>
      var subColors = [];

      function createImageBox(containerId,dataURL,id){
        let imgBox=`
          <div id="${id}" class="image-box m-3" style="background-image:url('${dataURL}');background-size:'cover';">
          </div>`;
          $(`#${containerId}`).append(imgBox);
      }
      
      function triggerFileInput(sourceInputId){
        $(`#${sourceInputId}`).trigger('click');
      }

      function readMultipleFiles(input) {
        $(`#source`).html("");
        subColors = [];
        if (input.files && input.files[0]) {
          let count = input.files.length;
          for (let i = 0; i < count; i++) {
            var reader = new FileReader();

            reader.onload = function (e) {
              let img = `<img src="${e.target.result}" alt="img" id="img_${
                i + 1
              }" class="sub-image" />`;
              let div = document.createElement("div");
              let imgEl = $("<img>", {
                id: `img_${i + 1}`,
                class: "sub-image",
                alt: "img",
                src: e.target.result,
                crossorigin: "anonymous",
              });
              imgEl.on("load", () => {
                calculateSubColor(imgEl);
              });
              console.log(imgEl);
              $(div).html(imgEl);
              $(`#source`).append(div);
              createImageBox('previewSubSource',e.target.result,`prev_img_${i+1}`);
            };

            reader.readAsDataURL(input.files[i]);
          }
        }
      }

      function readURL(input, output = "i",preview="previewSource") {
        if (input.files && input.files[0]) {
          var reader = new FileReader();

          reader.onload = function (e) {
            $(`#${output}`).attr("src", e.target.result);
            // $(`#${preview}`).css("background-image",`url('${e.target.result}')`).find('*').hide();
            createImageBox('previewSource',e.target.result,"prev_source_img");
          };

          reader.readAsDataURL(input.files[0]);
        }
      }
      function calculateSubColor(imgEl) {
        let imgId = imgEl.attr("id");
        let rgb = getAverageRGB(
          document.getElementById(imgId),
          0,
          0,
          imgEl.width()
        );
        let itemIndex = subColors.findIndex(
          (item) => item.r === rgb.r && item.g === rgb.g && item.b === rgb.b
        );
        if (itemIndex < 0) {
          rgb.id = imgId;
          rgb.colorVal = getColorVal(rgb);
          subColors.push(rgb);
          subColors = [...new Set(subColors)];
          console.log(subColors, itemIndex);
        }
        let div = `<div class="align-self-end shadow mb-2 rounded" style="background:rgb(${rgb.r},${rgb.g},${
          rgb.b
        });width:20px;height:20px" id="clr_${imgId}"></div>`;
        $(`#clr_${imgId}`).remove();
        imgEl.after(div);
        $(`#prev_${imgId}`).append(div);
      }
      function getColorVal(rgb) {
        let r = parseFloat(rgb.r * 0.2126);
        let g = parseFloat(rgb.g * 0.7152);
        let b = parseFloat(rgb.b * 0.0722);
        return parseFloat(r + g + b);
      }

      $(document).ready(() => {
        $("input").val("");

        $("#i").on("load", () => {
          setDefaults();
          $(`#outputLoader`).show();
          processImage(() => {
            $(`#outputLoader`).hide();
          });
        });
        $("#blockSize").on("input", (e) => {
          if (e.target.value < 5) {
            $("#blockSize").val(5);
          }
          $(`#sliderVal`).text($("#blockSize").val());
        });
        $("#btnRender").on("click", (e) => {
          let btnElement = $("#btnRender");
          btnElement.prop("disabled", true);
          btnElement.text("Rendering...");
          $(`#outputLoader`).show();
          setTimeout(() => {
            processImage(() => {
              btnElement.prop("disabled", false);
              btnElement.text("Render");
              $(`#outputLoader`).hide();
              renderPreview(document.getElementById("outputCanvas"));
            });
          }, 100);
        });
      });

      function outputImage(rgbProps) {
        let params = parseInputs();

        let maxHeight = params.imgHeight - params.blockSize;
        let maxWidth = params.imgWidth - params.blockSize;
        let positionI = 0;
        var canvas = document.getElementById("outputCanvas");
        var context = canvas.getContext && canvas.getContext("2d");
        for (let i = 0; i < params.gridRows; i++) {
          let positionJ = 0;
          for (let j = 0; j < params.gridCols; j++) {
            let rgb = rgbProps[i][j];
            if (rgb) {
              // let div=`<div style="background:rgb(${rgb.r},${rgb.g},${rgb.b})" id="box_${i}_${j}"></div>`;
              // grid.append(div);
              if (subColors.length > 0) {
                let colorVal = getColorVal(rgb);
                let min = Math.abs(colorVal - subColors[0].colorVal);
                let match = subColors[0];
                subColors.forEach((item) => {
                  let diff = Math.abs(colorVal - item.colorVal);
                  if (diff < min) {
                    min = diff;
                    match = item;
                  }
                });
                if (match) {
                  //  let imgSrc= $(`#${match.id}`).attr('src');
                  //  let img= `<img src="${imgSrc}" style="width:${params.blockSize}px;height:${params.blockSize}px" alt="img" id="box_${i}_${j}"></img>`;
                  // grid.append(img);

                  var img = document.getElementById(match.id);
                  context.drawImage(
                    img,
                    0,
                    0,
                    500,
                    500,
                    positionJ,
                    positionI,
                    params.blockSize * 10,
                    params.blockSize * 10
                  );
                }
              }
            }
            positionJ += params.blockSize * 10;
          }
          positionI += params.blockSize * 10;
        }
      }

      function setDefaults() {
        $("#blockSize").val(5);
        $("#sliderVal").text(5);
      }

      function processImage(callback = null) {
        extractRGB().then((data) => {
          outputImage(data);
          if (callback) {
            callback();
          }
        });
      }

      function parseInputs() {
        let blockSize = parseInt($("#blockSize").val());
        if (blockSize < 5) {
          blockSize = 5;
          $("#blockSize").val(blockSize);
        }
        let imgWidth = parseInt($("#i").width());
        let imgHeight = parseInt($("#i").height());
        let gridRows = ~~(imgWidth / blockSize);
        let gridCols = ~~(imgHeight / blockSize);

        return {
          blockSize,
          imgWidth,
          imgHeight,
          gridRows,
          gridCols,
        };
      }

      function extractRGB(imageId = "i") {
        return new Promise((resolve, reject) => {
          let rgbProps = [];
          let params = parseInputs();
          let imgElem = document.getElementById(`${imageId}`);
          let maxHeight = params.imgHeight - params.blockSize;
          let maxWidth = params.imgWidth - params.blockSize;
          for (let i = 0; i <= maxHeight; i += params.blockSize) {
            let row = [];
            for (let j = 0; j <= maxWidth; j += params.blockSize) {
              let rgb = getAverageRGB(imgElem, j, i, params.blockSize);
              row.push(rgb);
            }
            rgbProps.push(row);
          }
          if (rgbProps.length > 0) {
            resolve(rgbProps);
          } else {
            reject([]);
          }
        });
      }

      function getAverageRGB(imgEl, sx = 0, sy = 0, blockSize = 5) {
        var gridSize = 5;
        var defaultRGB = {
            r: 255,
            g: 255,
            b: 255,
          }, // for non-supporting envs
          canvas = document.createElement("canvas"),
          context = canvas.getContext && canvas.getContext("2d"),
          data,
          width,
          height,
          i = -4,
          length,
          rgb = {
            r: 0,
            g: 0,
            b: 0,
          },
          count = 0;

        if (!context) {
          return defaultRGB;
        }

        // height = canvas.height =
        //   imgEl.naturalHeight || imgEl.offsetHeight || imgEl.height;
        // width = canvas.width =
        //   imgEl.naturalWidth || imgEl.offsetWidth || imgEl.width;

        height = canvas.height = width = canvas.width = blockSize;

        context.drawImage(
          imgEl,
          sx,
          sy,
          blockSize,
          blockSize,
          0,
          0,
          blockSize,
          blockSize
        );
        // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

        try {
          // data = context.getImageData(0, 0, width, height);
          data = context.getImageData(0, 0, blockSize, blockSize);

          // let output = `<img alt="output" src="${canvas.toDataURL(
          //   "image/png"
          // )}" />`;
          // $("#outputContainer").html(output);
        } catch (e) {
          /* security error, img on diff domain */
          console.log(e);
          return defaultRGB;
        }

        length = data.data.length;

        while ((i += gridSize * 4) < length) {
          ++count;
          rgb.r += data.data[i];
          rgb.g += data.data[i + 1];
          rgb.b += data.data[i + 2];
        }

        // ~~ used to floor values
        rgb.r = ~~(rgb.r / count);
        rgb.g = ~~(rgb.g / count);
        rgb.b = ~~(rgb.b / count);

        return rgb;
      }

      function drawCanvas(imgId, dx = 0, dy = 0) {
        let params = parseInputs();
      }

      function openCanvas() {
        window.open(document.getElementById("outputCanvas").toDataURL());
      }

      function renderPreview(outputCanvas) {
        // var canvas = document.createElement("canvas");
        // var context = canvas.getContext && canvas.getContext("2d");
        // canvas.height=canvas.width=500;
        // context.drawImage(outputCanvas,0,0);
        let src = outputCanvas.toDataURL();
        let img = `<img width="500px" height="500px" style="cursor:pointer" src="${src}" alt="img" />`;
        $("#preview").attr("src", `${src}`);
        $("#downloadLink").attr("href", `${src}`);
      }
    </script>
  </body>
</html>
