<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
      integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <style>
      .selection-box {
        position: absolute;
        /* border: 1px solid red; */
        transition: all 0.5s ease;
        /* box-shadow: 1px 1px 1px 1px; */
      }
.output-grid{
  display: grid;
  grid-gap: 0px;
    /* grid-template-columns: repeat(4, 100px);
    grid-template-rows: repeat(4,100px); */
}
      .grid-item{
        width: 100px;
        height: 100px;
      }
    </style>

    <div class="container py-5">
      <h6>
        Choose an image and block size then click "Extract"
      </h6>
      <div class="d-flex align-items-center">
        <input type='file' onchange="readURL(this);" />
        <label for="blockSize" class="px-2">Block Size</label>
        <input type="range" id="blockSize" class="ml-2" min="5" value="5" max="100" step="5" placeholder="Block Size" />
        <div class="d-flex justify-content-center align-items-center mx-2 border rounded-circle " style="width: 32px;height: 32px;">
          <span id="sliderVal" class="text-center text-primary p-2">5</span>
        </div>
        <button class="btn btn-primary btn-sm mx-3" id="btnExtract">Extract</button>

      </div>

      <div id="imgContainer" class="img-container mt-3 d-flex">
        <div id="sourceContainer">
          <div class="selection-box shadow border" id="selectionBox"></div>
          <img src="img.png" alt="img" id="i" />
        </div>
        <div id="outputContainer">
          <div class="output-grid" id="outputGrid">
            <div class="spinner-border text-dark" role="status">
              <span class="sr-only"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
function readURL(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();

    reader.onload = function (e) {
      $("#i").attr("src", e.target.result);
    };

    reader.readAsDataURL(input.files[0]);
  }
}
      $(document).ready(() => {
        setDefaults();
        processImage();
        $("#blockSize").on('input',(e)=>{
          if(e.target.value<5){
            $("#blockSize").val(5);
          }
          $(`#sliderVal`).text($("#blockSize").val());
        })
        $("#btnExtract").on("click",(e)=>{
          let btnElement= $("#btnExtract");
          btnElement.prop("disabled",true);
          btnElement.text("Extracting...");
          setTimeout(()=>{
            processImage(()=>{
              btnElement.prop("disabled",false);
              btnElement.text("Extract");
            });
          },100)
        })

      });

      function outputImage(rgbProps){
        let params= parseInputs();
        let grid=$("#outputGrid");
        grid.html("");
        grid.css({
          "grid-template-rows":`repeat(${params.gridRows},${params.blockSize}px)`,
          "grid-template-columns":`repeat(${params.gridCols},${params.blockSize}px)`,
        })
        let maxHeight= params.imgHeight-params.blockSize;
        let maxWidth =  params.imgWidth-params.blockSize;
        for(let i=0;i<params.gridRows;i++){
          for(let j=0;j<params.gridCols;j++){
            let rgb=rgbProps[i][j];
            if(rgb){
              let div=`<div style="background:rgb(${rgb.r},${rgb.g},${rgb.b})" id="box_${i}_${j}"></div>`;
              grid.append(div);
            }
          }
        }
      }

      function setDefaults(){
        $("#blockSize").val(5);
        $("#sliderVal").text(5);
      }

      function processImage(callback=null) {
      extractRGB().then(data=>{
              outputImage(data);
              if(callback){
                callback();
              }
            });
      }

function parseInputs(){
        let blockSize= parseInt($("#blockSize").val());
        if(blockSize<5){
          blockSize=5;
          $("#blockSize").val(blockSize);
        }
        let imgWidth= parseInt($('#i').width());
        let imgHeight= parseInt($('#i').height());
          let gridRows= ~~(imgWidth/blockSize);
          let gridCols= ~~(imgHeight/blockSize);

          return {
            blockSize,
            imgWidth,
            imgHeight,
            gridRows,
            gridCols
          };
}

      function extractRGB(){
  
        return new Promise((resolve,reject)=>{
          let rgbProps=[];
        let params= parseInputs();
        let imgElem= document.getElementById("i");
        let maxHeight= params.imgHeight-params.blockSize;
        let maxWidth =  params.imgWidth-params.blockSize;
        for(let i=0;i<=maxHeight;i+=params.blockSize){
          let row=[];
          for(let j=0;j<=maxWidth;j+=params.blockSize){
            let rgb = getAverageRGB(imgElem,j, i,params.blockSize);
            row.push(rgb);
          }
          rgbProps.push(row);
        }
        if(rgbProps.length>0){
          resolve(rgbProps);
        }
        else{
          reject([]);
        }
        })
      }

      function getAverageRGB(imgEl, sx = 0, sy = 0,blockSize=5) {
        var gridSize=5;
        var defaultRGB = {
            r: 255,
            g: 255,
            b: 255,
          }, // for non-supporting envs
          canvas = document.createElement("canvas"),
          context = canvas.getContext && canvas.getContext("2d"),
          data,
          width,
          height,
          i = -4,
          length,
          rgb = {
            r: 0,
            g: 0,
            b: 0,
          },
          count = 0;

        if (!context) {
          return defaultRGB;
        }

        // height = canvas.height =
        //   imgEl.naturalHeight || imgEl.offsetHeight || imgEl.height;
        // width = canvas.width =
        //   imgEl.naturalWidth || imgEl.offsetWidth || imgEl.width;

        height = canvas.height = width = canvas.width = blockSize;

        context.drawImage(
          imgEl,
          sx,
          sy,
          blockSize,
          blockSize,
          0,
          0,
          blockSize,
          blockSize
        );
        // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

        try {
          // data = context.getImageData(0, 0, width, height);
          data = context.getImageData(0, 0, blockSize, blockSize);

          // let output = `<img alt="output" src="${canvas.toDataURL(
          //   "image/png"
          // )}" />`;
          // $("#outputContainer").html(output);
        } catch (e) {
          /* security error, img on diff domain */
          console.log(e);
          return defaultRGB;
        }

        length = data.data.length;

        while ((i += gridSize * 4) < length) {
          ++count;
          rgb.r += data.data[i];
          rgb.g += data.data[i + 1];
          rgb.b += data.data[i + 2];
        }

        // ~~ used to floor values
        rgb.r = ~~(rgb.r / count);
        rgb.g = ~~(rgb.g / count);
        rgb.b = ~~(rgb.b / count);

        return rgb;
      }
    </script>
  </body>
</html>
