<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
      integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <style>
      .selection-box {
        position: absolute;
        /* border: 1px solid red; */
        transition: all 0.5s ease;
        /* box-shadow: 1px 1px 1px 1px; */
      }
    </style>

    <div class="container">
      <h6 class="p-3">
        Setting the BODY's background to the average color in the following
        image:
      </h6>
      <div>
        <label for="inpX">Offset X</label>
        <input type="number" id="inpX" min="0" step="10" placeholder="Offset X" />
        <label for="inpY">Offset Y</label>
        <input type="number" id="inpY" min="0" step="10" placeholder="Offset Y" />
        <label for="blockSize">Block Size</label>
        <input type="number" id="blockSize" min="0" step="10" placeholder="Block Size" />
      </div>

      <div id="imgContainer" class="img-container mt-3 d-flex">
        <div id="sourceContainer">
          <div class="selection-box shadow border" id="selectionBox"></div>
          <img src="img.png" alt="img" id="i" />
        </div>
        <div id="outputContainer"></div>
      </div>
    </div>

    <script>

      $(document).ready(() => {
        setDefaults();
        processImage();
        $("#inpX").on("change", () => {
          processImage();
        });

        $("#inpY").on("change", () => {
          processImage();
        });

        $("#blockSize").on("change", (e) => {
          processImage();
        });

      });

      function setDefaults(){
        $("#inpX").val(0);
        $("#inpY").val(0);
        $("#blockSize").val(100);
      }
      function processImage() {
        let offsetX = parseInt($("#inpX").val());
        let offsetY = parseInt($("#inpY").val());
        let blockSize= parseInt($("#blockSize").val());
        let imgWidth= parseInt($('#i').width());
        let imgHeight= parseInt($('#i').height());
        if(imgWidth<=(offsetX+blockSize))
        {
          offsetX=imgWidth-blockSize;
          $("#inpX").val(offsetX);
        }

        if(imgHeight<=(offsetY+blockSize))
        {
          offsetY=imgHeight-blockSize;
          $("#inpY").val(offsetY);
        }
console.log(offsetX,offsetY);

        $("#selectionBox")
          .width(blockSize)
          .height(blockSize)
          .css({ "margin-left": offsetX + "px","margin-top":offsetY+"px" });

        var rgb = getAverageRGB(document.getElementById("i"), offsetX, offsetY,blockSize);
        $("#outputContainer").css(
          "background",
          `rgb(${rgb.r},${rgb.g},${rgb.b})`
        );
      }
      //   document.body.style.backgroundColor =
      //     "rgb(" + rgb.r + "," + rgb.g + "," + rgb.b + ")";


      function drawRGBImage(){
        let rgbProps=[];
        let imgWidth= parseInt($('#i').width());
        let imgHeight= parseInt($('#i').height());
      }

      function getAverageRGB(imgEl, sx = 0, sy = 0,blockSize=100) {
        var gridSize=5;
        var defaultRGB = {
            r: 255,
            g: 255,
            b: 255,
          }, // for non-supporting envs
          canvas = document.createElement("canvas"),
          context = canvas.getContext && canvas.getContext("2d"),
          data,
          width,
          height,
          i = -4,
          length,
          rgb = {
            r: 0,
            g: 0,
            b: 0,
          },
          count = 0;

        if (!context) {
          return defaultRGB;
        }

        // height = canvas.height =
        //   imgEl.naturalHeight || imgEl.offsetHeight || imgEl.height;
        // width = canvas.width =
        //   imgEl.naturalWidth || imgEl.offsetWidth || imgEl.width;

        height = canvas.height = width = canvas.width = blockSize;

        context.drawImage(
          imgEl,
          sx,
          sy,
          blockSize,
          blockSize,
          0,
          0,
          blockSize,
          blockSize
        );
        // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

        try {
          // data = context.getImageData(0, 0, width, height);
          data = context.getImageData(0, 0, blockSize, blockSize);

          let output = `<img alt="output" src="${canvas.toDataURL(
            "image/png"
          )}" />`;
          $("#outputContainer").html(output);
        } catch (e) {
          /* security error, img on diff domain */
          console.log(e);
          return defaultRGB;
        }

        length = data.data.length;

        while ((i += gridSize * 4) < length) {
          ++count;
          rgb.r += data.data[i];
          rgb.g += data.data[i + 1];
          rgb.b += data.data[i + 2];
        }

        // ~~ used to floor values
        rgb.r = ~~(rgb.r / count);
        rgb.g = ~~(rgb.g / count);
        rgb.b = ~~(rgb.b / count);

        return rgb;
      }
    </script>
  </body>
</html>
